# マルチプレイヤークイズアプリ - 実装メモ

## 実装した機能

### 1. WebSocketサーバーの修正
- **問題**: サーバーコードに構文エラーがあり、WebSocket接続が失敗していた
- **解決**: `server/websocket-server.js`の構文エラーを修正
  - メッセージハンドラーの重複コードを削除
  - 正しいswitch-case構造に修正
  - 接続終了処理を正しく実装

### 2. 正解者数の表示機能
- **実装内容**:
  - サーバー側で各問題の正解者数を計算
  - クライアント側で正解者数を表示
  - 表示形式: `🎯 正解者: X / Y人`

- **変更ファイル**:
  - `server/websocket-server.js`: `showQuestionResults()`メソッドに正解者数計算ロジックを追加
  - `src/screens/SyncQuizScreen.js`: 正解者数表示UIを追加
  - `src/context/GameContext.js`: 正解者数データの処理を追加

### 3. ゲームフローの実装
現在のゲームフローは以下の通りです：

```
1. 待機室 (WaitingRoomScreen)
   ↓ 全員準備完了
2. 説明画面 (InstructionsScreen) - 15秒
   ↓
3. サンプルクイズ (SyncQuizScreen) - 2問×10秒
   ↓
4. 本番準備画面 (PreparationScreen) - 10秒
   ↓
5. 本番クイズ (SyncQuizScreen) - 5問×20秒
   ↓
6. 結果画面 (RankingScreen)
```

### 4. 同期機能の改善
- **サーバー時刻同期**: クライアントとサーバーの時刻差を計算して同期
- **タイマー同期**: 全プレイヤーが同じカウントダウンを表示
- **状態管理**: サーバーが全体の進行を制御
- **デバッグログ**: 各フェーズの遷移をコンソールで確認可能

### 5. ランキング画面の改善
- マルチプレイヤーモードに対応
- プレイヤーのスコアを表示
- 自分のランキングをハイライト表示

## 使用方法

### サーバーの起動
```bash
cd server
npm install
npm start
```

### クライアントの起動
```bash
npm install
npm start
```

### ゲームの流れ

1. **ログイン画面**
   - ユーザー名を入力
   - 「マルチプレイヤー」を選択

2. **ルーム画面**
   - 「ルームを作成」または「ルームに参加」を選択
   - ルームコードを共有/入力

3. **待機室**
   - 全プレイヤーが「準備完了」をクリック
   - ホストが「ゲーム開始」をクリック

4. **ゲーム進行**
   - 説明画面（15秒）
   - サンプルクイズ（2問×10秒）
   - 本番準備画面（10秒）
   - 本番クイズ（5問×20秒）
   - 結果画面

## 技術的な詳細

### WebSocket通信
- **接続URL**: `ws://localhost:3001/room/{roomCode}`
- **メッセージタイプ**:
  - `join`: ルーム参加
  - `timeSync`: 時刻同期
  - `playerReady`: 準備完了
  - `startGame`: ゲーム開始
  - `submitAnswer`: 回答送信
  - `questionEnd`: 問題終了（結果表示）
  - `gameEnd`: ゲーム終了

### 状態管理
- **GameContext**: ゲーム全体の状態を管理
  - `gameState`: 現在のゲーム状態
  - `players`: プレイヤー一覧
  - `currentQuestion`: 現在の問題番号
  - `timeLeft`: 残り時間
  - `showResults`: 結果表示フラグ

### タイマー同期
- サーバーから送信される`startTime`を基準にタイマーを同期
- クライアント側でサーバー時刻との差分を計算
- 定期的に残り時間を再計算して表示

## トラブルシューティング

### WebSocket接続エラー
- サーバーが起動しているか確認: `ps aux | grep websocket-server`
- ポート3001が使用可能か確認: `lsof -i :3001`
- ファイアウォールの設定を確認

### 待機室に誰もいない
- WebSocket接続が成功しているか確認
- ブラウザのコンソールでエラーメッセージを確認
- サーバーのログを確認: `cat /tmp/websocket-server.log`

### タイマーがずれる
- サーバー時刻同期が正しく動作しているか確認
- ネットワーク遅延が大きい場合は調整が必要

## 今後の改善点

1. **エラーハンドリング**
   - WebSocket切断時の再接続処理
   - ネットワークエラーの適切な処理

2. **パフォーマンス**
   - 大人数での動作確認
   - メモリリークの確認

3. **UI/UX**
   - アニメーション効果の追加
   - サウンドエフェクトの追加
   - より詳細な統計情報の表示

4. **セキュリティ**
   - ルームコードの暗号化
   - 不正な回答の検証

## 変更ファイル一覧

- `server/websocket-server.js`: サーバーコードの修正、正解者数計算の追加
- `src/context/GameContext.js`: 時刻同期、状態管理の改善
- `src/screens/SyncQuizScreen.js`: 正解者数表示、UI改善
- `src/screens/RankingScreen.js`: マルチプレイヤー対応
- `App.js`: 画面遷移ロジックの改善
